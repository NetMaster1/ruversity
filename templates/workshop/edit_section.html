{% extends "base.html" %}
{% load static %}
{% block content %}
<!-- <body oncontextmenu="return false;"> -->
<div class="container">
        <div class="row m-auto">
            <nav style="--bs-breadcrumb-divider: url(&#34;data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='8' height='8'%3E%3Cpath d='M2.5 0L1 1.5 3.5 4 1 6.5 2.5 8l4-4-4-4z' fill='currentColor'/%3E%3C/svg%3E&#34;);"
                aria-label="breadcrumb">
                <ol class="breadcrumb">
                    <li class="breadcrumb-item"><a href="{% url 'studio' %}">Творческая студия</a></li>
                    <li class="breadcrumb-item"><a href="{% url 'edit_subject' subject.id %}">Редактирование курса</a></li>
                    <li class="breadcrumb-item"><a href="{% url 'edit_section' subject.id section.id %}">Разделы</a></li>
                    <li class="breadcrumb-item active" aria-current="page">Лекции</li>
                </ol>
            </nav>
        </div>
<div class="row m-auto">
    <h3>Редактировать Раздел {{section.enumerator}}: {{section.title}}</h3>
</div>

<div class="row m-auto">
    <form action="{% url 'edit_section' subject.id section.id %}" method="POST">
        {% csrf_token %}

        <div class="form-row">
            <!-- <div class="col-3">
                <input class='form-control' type="number" id="enumerator" name="enumerator"
                    placeholder="Изменить порядковый раздела" required>
            </div> -->
            <div class="col-6">
                <input class='form-control' type="text" id="title" name="title" placeholder="Изменить название раздела"
                    required>
            </div>

            <div class="col-2 align-self-end">
                <!-- <button type='submit' value="Create" class="btn btn-info btn-block"> -->
                <!-- <input type="submit" value="Create" class="btn btn-info btn-block "> -->
                <input type="submit" value="Редактировать" class='btn btn-block btn-outline-dark'>
                <!-- <input type="reset" value="Очистить" class="btn btn-sm btn-block btn-outline-dark"> -->
            </div>
        </div>
    </form>

    <!-- <div class="col-2 align-self-end">
        <a href="{% url 'delete_section' subject.id section.id %}" style="text-decoration: none">
            <input type="button" value="Удалить раздел" class='btn btn-block btn-outline-dark'>
        </a>
    </div> -->
</div>

<div class="row mt-3 border rounded bg-light text-center">
    <h3>Лекции</h3>
</div>

<!-- =============================uploading multiple files module=============================== -->
<div class="row mt-3">
    <form action="{% url 'upload_multiple_files' subject.id section.id %}" method="POST" enctype="multipart/form-data">
        {% csrf_token %}
    
        <div class="form-row mt-1 mb-1">
            <div class="col-5">
                <label for="multiple_file">
                    <strong>
                        Загрузите видеофайл/ы mp4 для данного раздела. Общий размер файлов не должен превышать 500Mb.
                    </strong>
                </label>
            </div>
            <div class="col-4">
                <input type="file" multiple class="form-control" id="multiple_files" name="multiple_files" required>
            </div>
        </div>

        <div class="form-row mb-3">
            <div class="col-5"></div>
            <div class="col-4">
                <input type="submit" value="Загрузить" class='btn btn-block btn-outline-dark'>
            </div>
        </div>
        </form>     
</div>
<!-- ======================================End of uploading multiple files module================================== -->
<!-- ===================================Create New Lecture Module================================================= -->
<div class="col-8">
    <div class="row m-auto">
        <div class="create_lecture">
            <h3>Создать новую лекцию</h3>
            <form action="{% url 'create_new_lecture' subject.id section.id %}" method="POST" enctype="multipart/form-data">
                {% csrf_token %}
                    <div class="form-row mt-1 mb-1">
                        <div class="col-6">
                            <label for="title">
                                <strong>Название лекции :</strong>
                            </label>
                        </div>
                        <div class="col-6">
                            <input type="text" class='form-control i-1' id="title" name="title" placeholder="Название лекции" required>
                        </div>
                    </div>
                    <div class="form-row mt-2">
                        <div class="col-5 pl-4">
                            <input type="checkbox" id='free_access' class='form-check-input' name='free_access' value='free_access'>
                        </div>
                        <div class="col-4">
                            <label for="free_access">
                                <strong>Отметьте, если это бесплатная лекция</strong>
                            </label>
                        </div>
                    </div>
                    <div class="form-row mb-3">
                        <div class="col-5"></div>
                        <div class="col-4">
                            <input type="submit" value="Создать" class='btn btn-block btn-outline-dark'>
                        </div>
                    </div>
            </form>
        </div>
    </div>
    <br>
</div>
<!-- ============================================End of Create New Lecture Module======================= -->


<!-- =============Create New Lecture Box============================================ -->   
<!-- <div class="row">
 
<div class="col-4">
    <div class="row m-auto">
        <h3>Библиотека загруженных видеофайлов.</h3>
    </div>
<div class="row">

    <div class="col-3"><h5>УИН</h5></div>
    <div class="col-8"><h5>Название файла</h5></div>
  
</div>

    {% for item in v_files%}

    <div class="row mb-2">
      
        <div class="col-2">
            <div class="hint">
                Перетащите поле с УИН лекции в соответсвующее поле в форме "Создать новую лекцию".
            </div>
            <div class="d-1" draggable="true">{{item.id}}</div>
        </div>
        <div class="col-8"><div class="file_title">{{item.video_file}}</div></div>
        <div class="col-1">
            <div class="my_alert">
                Нажатие на кнопку приведет к удалению видеофайла и соответствующей лекции, если видеофайл уже был использован для создания лекции.
            </div>
            <a href="{% url 'delete_lecture' item.id %}" style="text-decoration: none">
                <input type="button" value="Удалить" class='btn btn-sm btn-block btn-outline-dark'><div class="col-1"> -->
                <!-- <button type="button" class="btn-close delete_cross" aria-label="Close"></button>
            </a>
        </div>
    </div>
    {% endfor %} -->

<!-- ==============End of Create New Lecture Box================================        -->

<!-- ====================Edit Lecture Box========================================== -->
<br>
    <h3>Подготовленные лекции. Раздел {{section.enumerator}}: {{section.title}}</h3>

<!-- <ul class="draggable-list" id="draggable-list"> -->

<form action="{% url 'bulk_lecture_enumerator_update' subject.id%}" method="POST" id='form_no_button'>
    {% csrf_token %}
 
<div class="connex">   

{% for lecture in lectures %}
{% if lecture.section == section %}
    <div class="row mt-2 collection mb-2">
        <div class='section_1'>
        <div data-bs-toggle="collapse" data-bs-target='#lecture{{lecture.id}}'>

                <div class="lecture_string ml-3 draggable" draggable="true">
                    <div class="row">
                        <div class="col-2">
                            <label for="lecture_id">Лекция {{lecture.enumerator}}</label>
                        </div>
                        <div class="col-2">
                            <input type="text" class='form-control' id="lecture_id" name="lecture_id" value='{{lecture.id}}' readonly>
                        </div>
                        <div class="col-8">
                            <strong>Название: {{lecture.title}};. Дл.: {{lecture.length_1}} Размер:
                                {{lecture.size_mb}} Mb</strong>
                        </div>
                    </div>
                </div>
        </div>

        <!-- <div class="collapse show" id='collapse-p'> -->
        <div class="collapse" id='lecture{{lecture.id}}'>
            <div class="row m-auto">
                Выберите тип наполнения лекции:
            </div>
            <div class="row m-auto">
                <div class="col-2">
                    <input type="button" value="Видеофайл" id="videoFile" class="btn btn-sm btn-block btn-outline-dark videoFileButton">
                </div>
                <div class="col-2">
                    <input type="button" value="Тест" id="test" class="btn btn-sm btn-block btn-outline-dark">
                </div>
                <div class="col-2">
                    <input type="button" value="Статья" id="article" class="btn btn-sm btn-block btn-outline-dark">
                </div>
                <div class="col-2">
                    <input type="button" value="Ссылка на код" id="code" class="btn btn-sm btn-block btn-outline-dark">
                </div>
                <div class="col-2">
                    <input type="button" value="Текстовый файл" id="docFile" class="btn btn-sm btn-block btn-outline-dark">
                </div>  
                <!-- <input type="button" value="Редактировать" id="lecture_title" class="btn btn-sm btn-block btn-outline-dark">
                       
                            <a href="{% url 'delete_enumerator' subject.id section.id lecture.id %}" style="text-decoration: none">
                                <input type="button" value="Удалить" class='btn btn-sm btn-block btn-outline-dark'>
                            </a> -->
            </div>
        </div>
    </div>
    </div>
<!-- ========================================VideoFileModule======================= -->
    <div class="videoFileModule">
            <div class="hide">
                <div class="file_box">
                  {{lecture.enumerator}}
              
                        <form action="{% url 'lecture_update' subject.id section.id lecture.id %}" method="POST" enctype="multipart/form-data">
                            {% csrf_token %}
                        
                            <div class="form-row mt-1 mb-1">
                                <div class="col-5">
                                    <label for="file">
                                        <strong>
                                            Выберите видеофайл из вашего хранилища:
                                        </strong>
                                    </label>
                                </div>
                                <div class="col-4">
                                    <input type="file" class="form-control" id="file" name="file" required>
                                </div>
                                <div class="col-2">
                                    <input type="submit" value="Загрузить" class='btn btn-block btn-outline-dark'>
                                </div>
                            </div>
                        </form>
                  

                    <div data-bs-toggle="collapse" data-bs-target='#v_files'>
                    
                        <div class="lecture_string ml-3 draggable" draggable="true">
                            <div class="row">
                            
                               Открыть список файлов
                            </div>
                        </div>
                    </div>

                    <div class="collapse" id='v_files' style="height:fit-content">
        {% for v_file in v_files %}

        <div class="row m-1">
            <div class="col-6">{{v_file.video_file}}</div>
            <div class="col-2">
            <a href="{% url 'lecture_update_from_lib' subject.id section.id lecture.id v_file.id  %}" style="text-decoration: none">
                <!-- <input type="submit" value="Delete" class="btn btn-info btn-block"> -->
                <input type="button" value="Загрузить из библиотеки" class='btn btn-sm btn-block btn-outline-dark'>
            </a>
            </div>
        </div>
       
       
        {% endfor %}
                 </div>
               
            </div>
</div>
    </div>

    <!-- ==================================End of Video File Module======================================================== -->


          
{% endif %}
{% endfor %}
</div>


</form>
<!-- </ul> -->

</div>
  
<script>
    //передает все необходимые значения, такие как: lecuture.id, lecture.title & so on
    console.log('start OK')


    const videoFileButton = document.querySelectorAll('.videoFileButton');
    const videoFileModule = document.querySelectorAll('.videoFileModule');
    const fileUploadButton = document.querySelectorAll('.fileUploadButton');
    const fileLibButton = document.querySelector('.fileLibButton');
    const fileLibUploadModule = document.querySelector('.fileLibUploadModule');
    //const FileUploadModule = document.querySelectorAll('.FileUploadModule');

    // videoFileButton.forEach('item', e => {
    //       item.addEventListener('click', e => {
    //            videoFileModule.forEach('item1', e => {
    //                item1.classList.add('openModal')
    //        });
    //    });

    for (let i = 0; i < videoFileButton.length; i++) {
        videoFileButton[i].addEventListener('click', e => {
            videoFileModule[i].classList.add('openModal')
        })
    }
  
    //  for (let i = 0; i < fileUploadButton.length; i++) {
    //        fileUploadButton[i].addEventListener('click', e => {
    //            FileUploadModule[i].classList.add('openModal')
    //        })
    //    }

    fileLibButton.addEventListener('click', e => {
        fileLibUploadModule.classList.add('openModal')
    })

    fileUploadButton.addEventListener('click', e => {
            fileUploadModule.classList.add('openModal')
        })

    const lectures = document.querySelectorAll('#lectureModal');
    const titles = document.querySelectorAll('#lecture_title');
    const buttons = document.querySelectorAll('.cross_button');
    const close_buttons = document.querySelectorAll('.close_button');

    const hint = document.querySelectorAll('.hint');
    const my_alert = document.querySelectorAll('.my_alert');
    const btn_close = document.querySelectorAll('.delete_cross');
    //const create_lecture = document.querySelector('.create_lecture');
    const lecture_note = document.querySelector('.lecture_note');
    //Drag & Drop API
    //const video_lib = document.querySelectorAll('.video_lib');
    const d_1 = document.querySelectorAll('.d-1');
    const i_1 = document.querySelector('.i-1');
    const d_2 = document.querySelectorAll('.d-2');
    const i_2 = document.querySelectorAll('.i-2');
    const collection = document.querySelectorAll('.collection')
    //const d_2 = document.querySelectorAll('.collection').getElementsByClassName('.d-2')
  
    
        for (let i = 0; i < titles.length; i++) {
            titles[i].addEventListener('click', e => {
                lectures[i].classList.add('openModal')
            })
        }

        for (let i = 0; i < buttons.length; i++) {
            buttons[i].addEventListener('click', e => {
                lectures[i].classList.remove('openModal')
                //location.reload();
            })
        }

         for (let i = 0; i < close_buttons.length; i++) {
                close_buttons[i].addEventListener('click', e => {
                    lectures[i].classList.remove('openModal')
                    //location.reload();
                })
            }

        for (let i = 0; i < d_1.length; i++) {
                d_1[i].addEventListener('mouseover', e=> {
                    //alert('asdfsdfsa')
                    hint[i].classList.add('openModal');
                })  
            };
 
       for (let i = 0; i < d_1.length; i++) {
            d_1[i].addEventListener('mouseleave', e => {
                hint[i].classList.remove('openModal');
            });
        };
     
        for (let i = 0; i < btn_close.length; i++) {
            btn_close[i].addEventListener('mouseover', (e) => {
                my_alert[i].classList.add('openModal');
            });
        };
     
        for (let i = 0; i < btn_close.length; i++) {
                btn_close[i].addEventListener('mouseleave', (e) => {
                    my_alert[i].classList.remove('openModal');
                });
            };


        //create_lecture.addEventListener('mouseover', (e) => {
         //   lecture_note.classList.add('openModal');
         //   }
        //);

        //create_lecture.addEventListener('mouseleave', (e) => {
        //        lecture_note.classList.remove('openModal');
        //    }
        //    );

    //=================Drag & Drop Module 1===============
        for (let i = 0; i < d_1.length; i++) {
            d_1[i].addEventListener('dragstart', dragStart);
            d_1[i].addEventListener('dragend', dragEnd);
            //d_2[i].addEventListener('dragstart', dragStart);
            //d_2[i].addEventListener('dragend', dragEnd);
        }
       
      //when we have for example a {% for item in lectures %} {% endfor%} construction opening 2 or more modals.
      //And each modal has several {% for file in files %} {% endfor %} constructions. The quantity of <div class='file'
      //is equal to number of modals multiplied by number of file in each modal
        for (let i = 0; i < d_2.length; i++) {
            d_2[i].addEventListener('dragstart', dragStart);
            d_2[i].addEventListener('dragend', dragEnd);
        }

     
        console.log(collection)
        console.log(d_2)

        function dragStart() {
            setTimeout(()=> {
            this.classList.add('d-1-hidden');
            }, 100)
        };
        
        function dragEnd() {
            setTimeout(()=> {
            this.classList.remove('d-1-hidden');
            }, 100)
        };

        i_1.addEventListener('dragover', dragOver)
        i_1.addEventListener('dragenter', dragEnter)
        i_1.addEventListener('dragleave', dragLeave)
        i_1.addEventListener('drop', dragDrop)



        for (let i = 0; i < titles.length; i++) {
            i_2[i].addEventListener('dragover', dragOver)
            i_2[i].addEventListener('dragenter', dragEnter)
            i_2[i].addEventListener('dragleave', dragLeave)
            i_2[i].addEventListener('drop', dragDrop)
            }
        
       
        function dragOver (e) {
            e.preventDefault();
        };
        function dragEnter () {
            this.classList.add('hovered');
        };
        function dragLeave () {
            this.classList.remove('hovered');
        };

        function dragDrop () {
            data= document.querySelector('.d-1-hidden').innerText;
            this.value=data;
        };

        function dragDrop1() {
                ol_id.appendChild('box')
            };
        //function dragDrop() {
        //    data = document.querySelector('.d-1-hidden').innerText;
        //    for (let i = 0; i < titles.length; i++) {
        //        i_2[i].value=data;
        //        };
        //    };


        //for (let i = 0; i < video_lib.length; i++) {
        //    b_1[i].addEventListener('click', e => {
        //        let data = video_lib[i].url;
       //         i_2.file = data;
        //    })
        //}
        
        //document.querySelector('.b-1').addEventListener('click', () => {
        //        let data = document.querySelector('.video_lib').innerHTML;
        //        document.querySelector('.i-1').value = data;
        //    })

    //Drag & drop module version 2
        //const draggable_list = document.getElementById('draggable-list')
        const dragListItems = document.querySelectorAll('.draggable-list li');
        const draggables = document.querySelectorAll('.draggable');
        const listItems = [];
        let dragStartIndex;
        const formNoButton = document.querySelector('#form_no_button')

         dragListItems.forEach((item, index) => {
                item.setAttribute('data-index', index);
                listItems.push(item)
            })
      

        draggables.forEach(draggable => {
                draggable.addEventListener('dragstart', dragStart_1);
            })

        dragListItems.forEach(item => {
            item.addEventListener('dragover', dragOver);
            item.addEventListener('drop', dragDrop_1);
            item.addEventListener('dragenter', dragEnter);
            item.addEventListener('dragleave', dragLeave);
        })
      
        function dragStart_1() {
                dragStartIndex = +this.closest('li').getAttribute('data-index')
         
            }
        function dragDrop_1() {
                const dragEndIndex = +this.getAttribute('data-index');
                swapItems(dragStartIndex, dragEndIndex);
                this.classList.remove('over')
                //formNoButton.submit();
        }

        function swapItems(fromIndex, toIndex) {
            const itemOne = listItems[fromIndex].querySelector('.draggable');
            const itemTwo = listItems[toIndex].querySelector('.draggable');

                //listItems[fromIndex].appendChild(itemTwo);
                listItems[toIndex].appendChild(itemOne);
                //draglistItems[toIndex].appendChild(itemOne);

                if (fromIndex < toIndex) {
                    for (let i = fromIndex; i < toIndex; i++) {
                        listItems[i].appendChild(listItems[i + 1].querySelector('.draggable'))
                    }
                }
                else {
                    for (let i = toIndex; i < fromIndex; i++) {
                        listItems[i + 1].appendChild(listItems[i].querySelector('.draggable'))
                    }
                }
                //setTimeout(() => { form.submit(); }, 100);
            }

    console.log('end OK')
</script>

{% endblock %}